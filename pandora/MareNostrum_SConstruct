


import os

release = ARGUMENTS.get('release', 1)
extremeDebug = ARGUMENTS.get('edebug', 0)
useMpi = ARGUMENTS.get('mpi', 1)

if int(useMpi) == 1:
	env = Environment(ENV=os.environ, CXX='mpicxx')
else:
	env = Environment(ENV=os.environ, CXX='g++')

env.VariantDir('build', '.')

libs = Split('pthread gdal hdf5 z tinyxml grass_gis boost_filesystem boost_system gomp')

if int(release) == 0:
	env['CCFLAGS'] = Split('-g -Wall -DTIXML_USE_STL -fopenmp -DPANDORADEBUG -DMPICH_IGNORE_CXX_SEEK')
	if int(extremeDebug)==1:
		env['CCFLAGS'] += ['-DPANDORAEDEBUG']
	libraryName = 'pandorad'
	pythonLibraryName = 'pyPandorad'
else:
	env['CCFLAGS'] = Split('-O3 -Wall -DTIXML_USE_STL -fopenmp -DMPICH_IGNORE_CXX_SEEK')
	libraryName = 'pandora'
	pythonLibraryName = 'pyPandora'

if int(useMpi)==1:
	env['CCFLAGS'] += ['-DPANDORAMPI']

coreFiles = Split('World.cxx StaticRaster.cxx Raster.cxx Agent.cxx Statistics.cxx SimulationRecord.cxx AgentRecord.cxx Serializer.cxx Simulation.cxx Config.cxx MpiFactory.cxx IncrementalRaster.cxx RasterLoader.cxx Action.cxx LoggerBase.cxx GeneralState.cxx ShpLoader.cxx')

analysisFiles = Split('analysis/Analysis.cxx analysis/AgentMean.cxx analysis/AgentSum.cxx analysis/AgentNum.cxx analysis/Output.cxx analysis/AgentStdDev.cxx analysis/GlobalAgentStats.cxx analysis/IndividualStats.cxx analysis/AgentHistogram.cxx analysis/AgentHDFtoSHP.cxx analysis/GlobalRasterStats.cxx analysis/RasterMean.cxx analysis/RasterSum.cxx')

srcFiles = coreFiles + analysisFiles

srcBaseFiles = [] 
for src in srcFiles:
	srcBaseFiles.append('build/'+src)

includeDirs = Split('. analysis/ /apps/HDF5/1.8.10-mpi/OPENMPI/GNU/include')
includeDirs += ['/apps/BOOST/1_52_0_py_3.3.0/GCC/include/']
includeDirs += ['/apps/TINYXML/2.6.2/include']
includeDirs += ['/apps/GDAL/1.9.2/include']
includeDirs += ['/apps/GRASS/6.4.3RC2/grass-6.4.3RC2/include/']

libDirs = Split('/apps/HDF5/1.8.10-mpi/OPENMPI/GNU/lib/ /apps/GDAL/1.9.2/lib /apps/TINYXML/2.6.2/lib')
libDirs += ['/apps/BOOST/1_52_0_py_3.3.0/GCC/lib/']
libDirs += ['/apps/GRASS/6.4.3RC2/grass-6.4.3RC2/lib/']

env.SharedLibrary(libraryName, srcBaseFiles, CPPPATH=includeDirs, LIBS=libs, LIBPATH=libDirs)

if int(useMpi) == 1:
	envPython = Environment(ENV=os.environ, CXX='mpicxx')
else:
	envPython = Environment(ENV=os.environ, CXX='g++')

envPython['LINKFLAGS'] = Split('-Wl,--export-dynamic,-no-undefined')
envPython.VariantDir('build_py', '.')

if int(release) == 0:
	envPython['CCFLAGS'] = Split('-g -Wall -DTIXML_USE_STL -DPANDORADEBUG -DMPICH_IGNORE_CXX_SEEK')	
	if int(extremeDebug)==1:
		envPython['CCFLAGS'] += ['-DPANDORAEDEBUG']
else:
	envPython['CCFLAGS'] = Split('-O3 -Wall -DTIXML_USE_STL -DMPICH_IGNORE_CXX_SEEK')

if int(useMpi)==1:
	envPython['CCFLAGS'] += ['-DPANDORAMPI']
	
srcPyFiles = [] 
for src in srcFiles:
	srcPyFiles.append('build_py/'+src)

srcPyFiles.append('build_py/pyBindings.cxx')

if int(useMpi) == 1:
	srcPyFiles.append('build_py/MpiStubCode.cxx')

libsPython = libs
libDirsPython = libDirs
includeDirsPython = includeDirs

libsPython += ['python3.3m']
libsPython += ['boost_python3']
libDirsPython += ['/apps/PYTHON/3.3.0/lib/']
includeDirsPython += ['/apps/PYTHON/3.3.0/include/python3.3/']

envPython.SharedLibrary(pythonLibraryName, srcPyFiles, CPPPATH=includeDirsPython, LIBS=libsPython, LIBPATH=libDirsPython )

